services:
  backend:
    restart: unless-stopped
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: returnshield_backend
    command: >
      sh -c "python manage.py migrate &&
             python manage.py runserver 0.0.0.0:8000"
    volumes:
      - ./backend:/app
    environment:
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-dev-secret}
      DJANGO_DEBUG: ${DJANGO_DEBUG:-1}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-*}
      DB_ENGINE: django.db.backends.postgresql
      DB_NAME: ${DB_NAME:-returnshield}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_HOST: db
      DB_PORT: 5432
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      APP_FRONTEND_URL: ${APP_FRONTEND_URL:-http://localhost:4173}
      BACKEND_URL: ${BACKEND_URL:-http://localhost:8000}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_LAUNCH: ${STRIPE_PRICE_LAUNCH:-}
      STRIPE_PRICE_SCALE: ${STRIPE_PRICE_SCALE:-}
      STRIPE_PRICE_ELITE: ${STRIPE_PRICE_ELITE:-}
      VITE_STRIPE_SECRET_KEY: ${VITE_STRIPE_SECRET_KEY:-}
      VITE_STRIPE_PUBLISHABLE_KEY: ${VITE_STRIPE_PUBLISHABLE_KEY:-}
      SHOPIFY_CLIENT_ID: ${SHOPIFY_CLIENT_ID:-}
      SHOPIFY_CLIENT_SECRET: ${SHOPIFY_CLIENT_SECRET:-}
      SHOPIFY_APP_URL: ${SHOPIFY_APP_URL:-http://localhost:3000}
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy

  frontend:
    restart: unless-stopped
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: returnshield_frontend
    command: sh -c "npm run build && npx serve -s dist -l 3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      VITE_API_URL: ${API_URL:-http://localhost:8000/api}
      VITE_POSTHOG_KEY: ${VITE_POSTHOG_KEY:-}
      VITE_POSTHOG_HOST: ${VITE_POSTHOG_HOST:-https://analytics.returnshield.app}
      VITE_STRIPE_PRICE_LAUNCH: ${VITE_STRIPE_PRICE_LAUNCH:-}
      VITE_STRIPE_PRICE_SCALE: ${VITE_STRIPE_PRICE_SCALE:-}
      VITE_STRIPE_PRICE_ELITE: ${VITE_STRIPE_PRICE_ELITE:-}
      VITE_STRIPE_SECRET_KEY: ${VITE_STRIPE_SECRET_KEY:-}
      VITE_STRIPE_PUBLISHABLE_KEY: ${VITE_STRIPE_PUBLISHABLE_KEY:-}
    ports:
      - "8088:3000"
    depends_on:
      - backend

  dashboard:
    restart: unless-stopped
    build:
      context: ./app-frontend
      dockerfile: Dockerfile
    container_name: returnshield_dashboard
    command: sh -c "npm run build && npx serve -s dist -l 4173"
    volumes:
      - ./app-frontend:/app
      - /app/node_modules
    environment:
      VITE_API_URL: ${APP_API_URL:-http://localhost:8000/api}
      VITE_STRIPE_PRICE_LAUNCH: ${VITE_STRIPE_PRICE_LAUNCH:-}
      VITE_STRIPE_PRICE_SCALE: ${VITE_STRIPE_PRICE_SCALE:-}
      VITE_STRIPE_PRICE_ELITE: ${VITE_STRIPE_PRICE_ELITE:-}
      VITE_POSTHOG_KEY: ${VITE_POSTHOG_KEY:-}
      VITE_POSTHOG_HOST: ${VITE_POSTHOG_HOST:-https://analytics.returnshield.app}
    ports:
      - "8081:4173"
    depends_on:
      - backend

  posthog-proxy:
    restart: unless-stopped
    build:
      context: ./posthog-proxy
      dockerfile: Dockerfile
    container_name: returnshield_posthog_proxy
    environment:
      POSTHOG_CLOUD_REGION: ${POSTHOG_CLOUD_REGION:-us}
    ports:
      - "${POSTHOG_PROXY_PORT:-9000}:8080"

  db:
    image: postgres:16
    container_name: returnshield_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-returnshield}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres} -d ${DB_NAME:-returnshield}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: returnshield_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  celery_worker:
    restart: unless-stopped
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: returnshield_celery_worker
    command: celery -A core worker --loglevel=info
    volumes:
      - ./backend:/app
    environment:
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-dev-secret}
      DJANGO_DEBUG: ${DJANGO_DEBUG:-1}
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-*}
      DB_ENGINE: django.db.backends.postgresql
      DB_NAME: ${DB_NAME:-returnshield}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_HOST: db
      DB_PORT: 5432
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      SHOPIFY_CLIENT_ID: ${SHOPIFY_CLIENT_ID:-}
      SHOPIFY_CLIENT_SECRET: ${SHOPIFY_CLIENT_SECRET:-}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  celery_beat:
    restart: unless-stopped
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: returnshield_celery_beat
    command: celery -A core beat --loglevel=info
    volumes:
      - ./backend:/app
    environment:
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:-dev-secret}
      DJANGO_DEBUG: ${DJANGO_DEBUG:-1}
      DB_ENGINE: django.db.backends.postgresql
      DB_NAME: ${DB_NAME:-returnshield}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_HOST: db
      DB_PORT: 5432
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  postgres_data:

